# 实现计划

- [x] 1. 创建数据大小计算核心工具类

  - 实现 DataSizeCalculator 类，提供对象大小计算功能
  - 实现内存大小计算算法，处理循环引用和复杂对象结构
  - 实现JSON序列化大小计算功能
  - 实现字节大小格式化工具（bytes, KB, MB等单位转换）
  - 创建数组统计信息计算方法，包含对象数量和平均大小
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 2. 扩展 TaskProgress 类型定义


  - 在 packages/types/src/analysis-task.ts 中定义 DataSizeStats 接口
  - 扩展现有的 FetchCompleteProgress 接口，在 data 字段中添加 dataSizeInfo
  - 扩展现有的 FilterCompleteProgress 接口，添加过滤前后的数据大小对比
  - 扩展现有的 SelectCompleteProgress 接口，添加筛选后的数据大小信息
  - 扩展现有的 FetchContentCompleteProgress 接口，添加完整内容数据大小
  - 扩展现有的 AnalyzeCompleteProgress 接口，添加分析结果数据大小
  - _需求: 5.1, 5.5_

- [x] 3. 实现监控配置管理




  - 创建 MonitoringConfig 接口定义监控级别和选项
  - 实现默认配置常量，设置基础监控级别
  - 实现环境变量配置读取功能，支持运行时配置调整
  - 实现配置验证逻辑，处理无效配置的降级策略
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 4. 创建数据大小监控服务类
  - 实现 DataSizeMonitor 服务类，集成配置管理和大小计算
  - 实现 shouldMonitor() 方法，根据配置决定是否进行监控
  - 实现 monitorData() 方法，处理数据大小计算和采样逻辑
  - 实现采样计算策略，当数据量超过阈值时启用采样模式
  - 实现错误处理机制，确保监控异常不影响主流程执行
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 5. 集成监控功能到任务执行服务
  - 在 AnalysisTaskExecutionService 中注入 DataSizeMonitor 服务
  - 在 FETCH_COMPLETE 状态更新中添加帖子数据大小计算
  - 在 FILTER_COMPLETE 状态更新中添加过滤前后数据大小对比
  - 在 SELECT_COMPLETE 状态更新中添加筛选后数据大小信息
  - 在 FETCH_CONTENT_COMPLETE 状态更新中添加完整内容数据大小
  - 在 ANALYZE_COMPLETE 状态更新中添加分析结果数据大小
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 6. 实现性能优化和错误处理
  - 实现计算超时机制，防止大数据集计算阻塞主线程
  - 实现内存使用监控，在内存不足时自动启用采样模式
  - 实现错误降级处理，计算失败时返回基础统计信息
  - 添加性能日志记录，监控数据大小计算对任务执行时间的影响
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 7. 创建单元测试
  - 为 DataSizeCalculator 创建单元测试，验证各种数据类型的大小计算准确性
  - 测试循环引用处理、大对象处理、数组统计计算等边界情况
  - 为 DataSizeMonitor 创建单元测试，验证配置管理和监控逻辑
  - 测试不同监控级别的行为差异和采样计算的准确性
  - 为扩展的 TaskProgress 类型创建类型测试，确保类型安全
  - _需求: 5.6_

- [ ] 8. 更新现有测试文件
  - 更新 analysis-task-execution.service.spec.ts 单元测试文件
  - 修改现有测试用例以适配扩展后的 TaskProgress 接口
  - 添加数据大小监控功能的单元测试用例
  - 验证监控功能不影响现有业务逻辑的正确性
  - _需求: 5.6_

- [ ] 9. 创建集成测试
  - 创建端到端集成测试，验证完整任务执行流程中的数据大小监控
  - 测试从任务开始到结束，每个阶段的数据大小信息都能正确记录和传递
  - 验证不同监控配置级别在真实环境中的行为表现
  - 测试大数据集场景下的性能表现和采样计算准确性
  - 验证监控功能对任务执行时间的影响在可接受范围内
  - _需求: 5.7, 3.1_

- [ ] 10. 添加错误处理和日志记录
  - 实现 DataSizeCalculationError 错误类型定义
  - 在各个计算环节添加 try-catch 错误处理
  - 实现详细的日志记录，包括计算时间、数据大小、采样状态等信息
  - 添加性能警告日志，当计算时间超过阈值时记录警告
  - 确保所有错误都不会中断主任务流程的执行
  - _需求: 3.3_
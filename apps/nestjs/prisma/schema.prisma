// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 分析任务模型 - 定义Reddit内容分析的自动化任务
model AnalysisTask {
  /// 任务唯一标识符，使用CUID格式自动生成
  id String @id @default(cuid())

  /// 任务名称，用于标识和管理不同的分析任务
  name String

  /// Cron表达式，定义任务的执行时间计划（如: "0 */6 * * *" 表示每6小时执行一次）
  cron String

  /// AI分析提示词，指导LLM如何分析Reddit内容
  prompt String

  /// 关键词列表，用于过滤和搜索相关的Reddit帖子
  keywords String[]

  /// 目标subreddit列表，指定要分析的Reddit社区
  subreddits String[]

  /// 任务当前状态：active(活跃)、paused(暂停)、running(运行中)
  status AnalysisTaskStatus @default(active)

  /// 是否启用内容过滤，用于筛选相关性更高的内容
  enableFiltering Boolean @default(true)

  /// 使用的LLM模型名称（如: gpt-3.5-turbo, gpt-4等），可选字段
  llmModel String?

  /// 上次执行时间，用于跟踪任务执行历史
  lastExecutedAt DateTime?

  /// 最后失败时间，记录任务最近一次执行失败的时间
  lastFailureAt DateTime?

  /// 简短的错误描述，用户友好的错误信息提示
  lastErrorMessage String?

  /// 关联的分析报告列表，一对多关系
  results AnalysisReport[]

  /// 任务创建时间，自动设置为当前时间
  createdAt DateTime @default(now())

  /// 任务最后更新时间，每次修改时自动更新
  updatedAt DateTime @updatedAt
}

/// 分析任务状态枚举 - 定义任务的不同执行状态
enum AnalysisTaskStatus {
  /// 活跃状态 - 任务已启用，等待按计划执行
  active

  /// 暂停状态 - 任务被用户手动暂停或失败次数过多被停止，不会执行
  paused

  /// 运行中状态 - 任务正在执行分析过程
  running
}

/// 分析报告模型 - 存储AI分析Reddit内容后生成的结果
model AnalysisReport {
  /// 报告唯一标识符，使用CUID格式自动生成
  id String @id @default(cuid())

  /// 报告生成时间，自动设置为当前时间
  createdAt DateTime @default(now())

  /// 分析结果内容，以JSON格式存储AI生成的分析报告
  content Json

  /// 执行耗时，记录生成此报告所花费的时间（毫秒）
  executionDuration Int?

  /// 关联的分析任务ID，外键引用AnalysisTask.id
  taskId String

  /// 关联的分析任务，多对一关系，任务删除时报告自动删除
  task AnalysisTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
}
